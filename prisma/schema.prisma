datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  GERENCIAMENTO
  EXECUCAO
}

enum TipoObra {
  RESIDENCIAL
  COMERCIAL
  INDUSTRIAL
  OUTRA
}

enum EtapaTipo {
  FUNDACAO
  ALVENARIA
  COBERTURA
  INSTALACOES
}

enum SubEtapaTipo {
  TERRAPLANAGEM
  PERFURACOES
  VIGA_BALDRAME
  PILARES
  VIGA_COROAMENTO
  LAJE
  INST_ELETRICAS
  INST_HIDRAULICAS
}

enum StatusEtapa {
  EM_ANDAMENTO
  FINALIZADO
}

enum TipoJustificativa {
  CHUVA
  FALHA_PROJETO
  ATRASO_MATERIAIS
  OUTRO
}

enum StatusPedido {
  PENDENTE
  PEDIDO_FEITO
  PEDIDO_RECEBIDO
}

model UsuarioGerenciamento {
  id                  Int                @id @default(autoincrement())
  razaoSocial         String
  inscricaoEstadual   String?
  cnpj                String             @unique
  dataFundacao        DateTime?
  telefone            String?
  email               String             @unique
  endereco            String
  senhaHash           String
  role                Role               @default(GERENCIAMENTO)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  obras               Obra[]
  usuariosExecucao    UsuarioExecucao[]
}

model UsuarioExecucao {
  id               Int                @id @default(autoincrement())
  nome             String
  cpf              String             @unique
  endereco         String
  creaCau          String             @unique
  telefone         String?
  email            String             @unique
  dataNascimento   DateTime?
  senhaHash        String
  role             Role               @default(EXECUCAO)
  empresa          UsuarioGerenciamento @relation(fields: [empresaId], references: [id])
  empresaId        Int
  obrasResponsavel Obra[]
}

model Obra {
  id                 Int                 @id @default(autoincrement())
  tipoObra           TipoObra
  endereco           String
  creaCauResponsavel String
  cno                String              @unique
  gerente            UsuarioGerenciamento @relation(fields: [gerenteId], references: [id])
  gerenteId          Int
  responsavel        UsuarioExecucao      @relation(fields: [responsavelId], references: [id])
  responsavelId      Int
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  etapas             EtapaObra[]
  materiaisPedidos   MaterialObra[]
  lembretes          LembreteMaterial[]
}

model JustificativaAtraso {
  id          Int             @id @default(autoincrement())
  tipo        TipoJustificativa
  descricao   String?
  etapas      EtapaObra[]
  createdAt   DateTime        @default(now())
}

model EtapaObra {
  id                 Int                 @id @default(autoincrement())
  obra               Obra                @relation(fields: [obraId], references: [id])
  obraId             Int
  tipo               EtapaTipo
  subEtapa           SubEtapaTipo?
  status             StatusEtapa        @default(EM_ANDAMENTO)
  dataPrevistaInicio DateTime?
  dataPrevistaFim    DateTime?
  dataRealInicio     DateTime?
  dataRealFim        DateTime?
  justificativa      JustificativaAtraso? @relation(fields: [justificativaId], references: [id])
  justificativaId    Int?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

model Material {
  id           Int           @id @default(autoincrement())
  nome         String
  etapaDefault EtapaTipo?
  unidade      String
  itens        MaterialObra[]
  lembretes    LembreteMaterial[]
}

model MaterialObra {
  id           Int           @id @default(autoincrement())
  obra         Obra          @relation(fields: [obraId], references: [id])
  obraId       Int
  material     Material      @relation(fields: [materialId], references: [id])
  materialId   Int
  etapa        EtapaTipo
  quantidade   Float
  statusPedido StatusPedido  @default(PENDENTE)
  dataPedido   DateTime?
  dataEntrega  DateTime?
}

model LembreteMaterial {
  id           Int        @id @default(autoincrement())
  obra         Obra       @relation(fields: [obraId], references: [id])
  obraId       Int
  material     Material   @relation(fields: [materialId], references: [id])
  materialId   Int
  etapa        EtapaTipo
  dataLembrete DateTime
  enviado      Boolean    @default(false)
  createdAt    DateTime   @default(now())
}
